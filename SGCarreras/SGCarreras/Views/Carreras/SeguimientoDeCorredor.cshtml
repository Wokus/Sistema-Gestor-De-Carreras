@model SGCarreras.Models.ViewModels.CorredorActivo

@{
    ViewData["Title"] = "Seguimiento en Vivo";
    string nombreCarrera = Model.carreraNombre;
    string corredorNombreInicial = Model.corredorNombre.Split(' ', StringSplitOptions.RemoveEmptyEntries).LastOrDefault()?.Substring(0, 1).ToUpper() ?? "?";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="display-5 fw-bold text-primary mb-2">
                        <i class="fas fa-route me-2"></i>Seguimiento en Vivo
                    </h1>
                    <p class="lead text-muted">Carrera: @nombreCarrera</p>
                </div>
                <div>
                    <a href="javascript:history.back()" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>

            <div id="mensajeMeta" class="alert alert-warning text-dark text-center fw-bold shadow-sm" style="display:none;">
                <i class="fas fa-medal me-2"></i>El corredor llegó a la meta
            </div>

            <div class="card border-0 shadow-lg mb-5">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-running me-2"></i>Información del Corredor
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4 text-center">
                            <div class="avatar-circle bg-primary text-white mx-auto mb-3" style="width: 120px; height: 120px; font-size: 48px;">
                                @corredorNombreInicial
                            </div>
                            <h3 class="fw-bold text-dark">@Model.corredorNombre</h3>
                            <p class="text-muted">Corriendo en @nombreCarrera</p>
                        </div>
                        <div class="col-md-8 border-start">
                            <dl class="row mb-0">
                                <dt class="col-sm-4 text-muted">Nombre:</dt>
                                <dd class="col-sm-8 fs-5 fw-bold text-primary" id="corredorNombre">@Html.DisplayFor(model => model.corredorNombre)</dd>

                                <dt class="col-sm-4 text-muted">Número del Corredor:</dt>
                                <dd class="col-sm-8 fs-5 fw-bold" id="nmroEnCarrera">
                                    <span class="badge bg-secondary fs-6">#@Html.DisplayFor(model => model.nmroEnCarrera)</span>
                                </dd>

                                <dt class="col-sm-4 text-muted">Distancia Transcurrida:</dt>
                                <dd class="col-sm-8 fs-5 fw-bold text-success" id="kilometro">
                                    <i class="fas fa-map-pin me-1"></i>@Html.DisplayFor(model => model.kilometro) km
                                </dd>

                                <dt class="col-sm-4 text-muted">Tiempo Transcurrido:</dt>
                                <dd class="col-sm-8 fs-5 fw-bold text-info" id="tiempo">
                                    <i class="fas fa-stopwatch me-1"></i>00:00:00
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-lg mt-4">
                <div class="card-header bg-light py-3">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>Progreso en Tiempo Real
                    </h4>
                </div>
                <div class="card-body py-4 px-5">

                    @{
                        // **IMPORTANTE**: Simulación de datos necesarios para la visualización.
                        // En una aplicación real, estas propiedades deberían estar en tu ViewModel CorredorActivo.
                        double kmTotalesCarrera = 10.0; // Distancia total de la carrera (ejemplo: 10 km)
                        List<double> kmPuntosControl = new List<double> { 2.0, 5.0, 8.0 }; // Kilómetros de los puntos de control

                        // Calculamos el progreso inicial del corredor
                        double progresoInicial = (Model.kilometro / kmTotalesCarrera) * 100.0;
                    }

                    <div class="progress-container mb-4 position-relative">
                        <div class="progress" style="height: 15px;">
                            <div id="progressCorredor" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar"
                                 style="width: @progresoInicial%;" aria-valuenow="@progresoInicial" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>

                        <i id="runnerIcon" class="fas fa-running runner-icon" style="left: @progresoInicial%;"></i>

                        <div class="track-marker start-marker">
                            <i class="fas fa-flag-checkered text-success"></i><br><small>Inicio</small>
                        </div>

                        <div class="track-marker end-marker">
                            <i class="fas fa-flag-checkered text-danger"></i><br><small>Meta (@kmTotalesCarrera Km)</small>
                        </div>

                        @foreach (var km in kmPuntosControl)
                        {
                            // Calcula la posición porcentual del punto de control
                            double percent = (km / kmTotalesCarrera) * 100.0;
                            <div class="track-marker checkpoint-marker" style="left: @percent%;">
                                <i class="fas fa-map-pin text-info"></i>
                                <small>@km Km</small>
                            </div>
                        }
                    </div>
                    <p class="text-center text-muted mt-4">Progreso: <span id="progresoPorcentaje">@string.Format("{0:N1}", progresoInicial)</span>% de la meta.</p>

                    <input type="hidden" id="kmTotalesCarrera" value="@kmTotalesCarrera" />
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tooltips (si los hubiese)
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // --- Variables para el progreso y la conexión ---
            const kmTotalesCarrera = parseFloat(document.getElementById("kmTotalesCarrera").value);
            const runnerIcon = document.getElementById("runnerIcon");
            const progressBar = document.getElementById("progressCorredor");
            const progresoPorcentajeText = document.getElementById("progresoPorcentaje");

            // Conexión y Lógica de SignalR
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7247/carrerasHub") // Ajustar URL si es necesario
                .withAutomaticReconnect()
                .build();

            // Función para formatear tiempo (asumiendo que viene en minutos)
            function formatTime(totalMinutes) {
                if (totalMinutes === null || totalMinutes === undefined) return '00:00:00';
                let totalSeconds = Math.round(totalMinutes * 60);
                const hours = Math.floor(totalSeconds / 3600);
                totalSeconds %= 3600;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                
                const pad = (num) => num.toString().padStart(2, '0');
                
                return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            }

            // Función para actualizar la posición visual del corredor
            function updateRunnerPosition(currentKm) {
                if (kmTotalesCarrera > 0) {
                    let progressPercent = (currentKm / kmTotalesCarrera) * 100;
                    
                    // Asegurar que el progreso no exceda el 100%
                    progressPercent = Math.min(100, Math.max(0, progressPercent));

                    // Actualizar la posición del icono (con animación CSS)
                    runnerIcon.style.left = progressPercent + '%';
                    
                    // Actualizar la barra de progreso
                    progressBar.style.width = progressPercent + '%';
                    progressBar.setAttribute('aria-valuenow', progressPercent);

                    // Actualizar texto de porcentaje
                    progresoPorcentajeText.textContent = progressPercent.toFixed(1);
                }
            }


            // Manejador de eventos del Hub
            connection.on("CorredorActualizado", (data) => {
                console.log("CorredorActualizado:", data);
                
                // 1. Actualización de Kilometraje y Posición Visual
                if (data.kilometro !== undefined) {
                    const currentKm = parseFloat(data.kilometro);
                    
                    document.getElementById("kilometro").innerHTML = `<i class="fas fa-map-pin me-1"></i>${currentKm.toFixed(2)} km`;
                    
                    updateRunnerPosition(currentKm);
                }
                
                // 2. Actualización de Tiempo
                if (data.tiempo !== undefined) {
                    const tiempoFormateado = formatTime(data.tiempo); 
                    document.getElementById("tiempo").innerHTML = `<i class="fas fa-stopwatch me-1"></i>${tiempoFormateado}`;
                }

                // 3. Lógica de Mensaje de Meta
                if (data.mensake) {
                    const finalTimeFormatted = formatTime(data.tiempoDeFinalizacion); 
                    document.getElementById("nmroEnCarrera").innerHTML = `<span class="badge bg-success fs-5">#${data.numeroEnCarrera} (Meta)</span>`;
                    
                    const nombre = document.getElementById("corredorNombre").textContent.trim();
                    const texto = `El corredor <strong>${nombre}</strong> llegó a la meta en el puesto <strong>${data.numeroEnCarrera}</strong> con un tiempo de <strong>${finalTimeFormatted}</strong>.`;
                    
                    const mensajeMetaDiv = document.getElementById("mensajeMeta");
                    mensajeMetaDiv.innerHTML = `<i class="fas fa-medal me-2"></i>${texto}`;
                    mensajeMetaDiv.classList.remove('alert-warning');
                    mensajeMetaDiv.classList.add('alert-success');
                    mensajeMetaDiv.style.display = "block";
                    
                    // Asegurar que el corredor y la barra estén al 100% al terminar
                    updateRunnerPosition(kmTotalesCarrera);

                    // Detener la conexión al finalizar
                    connection.stop();
                    console.log("Conexión SignalR detenida, el corredor ha finalizado.");
                }
            });

            // Iniciar Conexión
            connection.start()
                .then(() => {
                    console.log("Conectado a SignalR.");
                    connection.invoke("UnirseACorredorCorriendoceUnaCarreraCarrerosa", @Model.registroId)
                        .catch(err => console.error("Error al invocar UnirseACorredorCorriendoceUnaCarreraCarrerosa:", err));
                })
                .catch(err => console.error("Error al conectar a SignalR:", err));
        });
    </script>
}

<style>
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }

    .avatar-circle {
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .bg-primary {
        background: linear-gradient(135deg, var(--bs-primary) 0%, #0056b3 100%) !important;
    }

    .bg-pink {
        background: linear-gradient(135deg, #e83e8c 0%, #d91a72 100%) !important;
    }

    .bg-info {
        background: linear-gradient(135deg, #0dcaf0 0%, #0aa7c7 100%) !important;
    }

    /* Estilos para el mensaje de meta */
    .alert-warning {
        border-left: 5px solid #ffc107;
    }

    .alert-success {
        border-left: 5px solid #198754;
    }

    .fas {
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
    }

    /* --- Estilos para la barra de progreso de la carrera --- */
    .progress-container {
        padding-top: 30px; /* Espacio para los marcadores superiores */
    }

    .runner-icon {
        position: absolute;
        top: 5px; /* Posiciona el icono ligeramente por encima de la barra */
        transform: translateX(-50%); /* Centra el icono en su punto de 'left' */
        color: #007bff; /* Color primario */
        font-size: 1.5rem;
        z-index: 10;
        transition: left 0.5s ease-out; /* Animación para el movimiento del corredor */
    }

    .track-marker {
        position: absolute;
        top: 0;
        text-align: center;
        transform: translateX(-50%);
        z-index: 5;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .checkpoint-marker i {
        color: #17a2b8; /* info */
    }

    .start-marker {
        left: 0% !important;
        transform: translateX(0%);
    }

        .start-marker i {
            color: #28a745; /* success */
        }

    .end-marker {
        left: 100% !important;
        transform: translateX(-100%);
    }

        .end-marker i {
            color: #dc3545; /* danger */
        }

    /* Fallbacks para iconos */
    .fa-arrow-left::before {
        content: "⬅️";
    }

    .fa-route::before {
        content: "🛣️";
    }

    .fa-running::before {
        content: "🏃";
    }

    .fa-map-pin::before {
        content: "📌";
    }

    .fa-stopwatch::before {
        content: "⏱️";
    }

    .fa-medal::before {
        content: "🏅";
    }

    .fa-chart-line::before {
        content: "📈";
    }

    .fa-chart-bar::before {
        content: "📊";
    }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">