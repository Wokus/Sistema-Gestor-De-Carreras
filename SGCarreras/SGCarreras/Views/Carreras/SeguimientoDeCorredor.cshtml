@model SGCarreras.Models.ViewModels.CorredorActivo

@{
    ViewData["Title"] = "Seguimiento en Vivo";
    string nombreCarrera = Model.carreraNombre;
    string corredorNombreInicial = Model.corredorNombre.Split(' ', StringSplitOptions.RemoveEmptyEntries).LastOrDefault()?.Substring(0, 1).ToUpper() ?? "?";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="display-5 fw-bold text-primary mb-2">
                        <i class="fas fa-route me-2"></i>Seguimiento en Vivo
                    </h1>
                    <p class="lead text-muted">Carrera: **@nombreCarrera**</p>
                </div>
                <div>
                    <a href="javascript:history.back()" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>

            <div id="mensajeMeta" class="alert alert-warning text-dark text-center fw-bold shadow-sm" style="display:none;">
                <i class="fas fa-medal me-2"></i>El corredor llegó a la meta
            </div>

            <div class="card border-0 shadow-lg mb-5">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-running me-2"></i>Información del Corredor
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4 text-center">
                            <div class="avatar-circle bg-primary text-white mx-auto mb-3" style="width: 120px; height: 120px; font-size: 48px;">
                                @corredorNombreInicial
                            </div>
                            <h3 class="fw-bold text-dark">@Model.corredorNombre</h3>
                            <p class="text-muted">Corriendo en **@nombreCarrera**</p>
                        </div>
                        <div class="col-md-8 border-start">
                            <dl class="row mb-0">
                                <dt class="col-sm-4 text-muted">@Html.DisplayNameFor(model => model.corredorNombre):</dt>
                                <dd class="col-sm-8 fs-5 fw-bold text-primary" id="corredorNombre">@Html.DisplayFor(model => model.corredorNombre)</dd>

                                <dt class="col-sm-4 text-muted">@Html.DisplayNameFor(model => model.nmroEnCarrera):</dt>
                                <dd class="col-sm-8 fs-5 fw-bold" id="nmroEnCarrera">
                                    <span class="badge bg-secondary fs-6">#@Html.DisplayFor(model => model.nmroEnCarrera)</span>
                                </dd>

                                <dt class="col-sm-4 text-muted">@Html.DisplayNameFor(model => model.kilometro):</dt>
                                <dd class="col-sm-8 fs-5 fw-bold text-success" id="kilometro">
                                    <i class="fas fa-map-pin me-1"></i>@Html.DisplayFor(model => model.kilometro) km
                                </dd>

                                <dt class="col-sm-4 text-muted">Tiempo Transcurrido:</dt>
                                <dd class="col-sm-8 fs-5 fw-bold text-info" id="tiempo">
                                    <i class="fas fa-stopwatch me-1"></i>00:00:00
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-lg">
                <div class="card-header bg-light py-3">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>Progreso en Tiempo Real
                    </h4>
                </div>
                <div class="card-body text-center py-5">
                    <div id="visualizacionProgreso">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Cargando visualización de progreso...</h5>
                        <p class="text-muted">Datos actualizados por SignalR.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tooltips (si los hubiese)
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Conexión y Lógica de SignalR
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7247/carrerasHub") // Ajustar URL si es necesario
                .withAutomaticReconnect()
                .build();

            // Función para formatear tiempo (simulado si viene en minutos)
            

            // Manejador de eventos del Hub
            connection.on("CorredorActualizado", (data) => {
                console.log("CorredorActualizado:", data);

                if (data.kilometro !== undefined) {
                    document.getElementById("kilometro").innerHTML = `<i class="fas fa-map-pin me-1"></i>${data.kilometro} km`;
                }

                if (data.tiempo !== undefined) {

                   document.getElementById("tiempo").textContent = data.tiempo;
                }

                // Lógica de Mensaje de Meta
                if (data.mensake) {
                    document.getElementById("nmroEnCarrera").textContent = data.numeroEnCarrera;

                    const nombre = document.getElementById("corredorNombre").textContent.trim();
                    const texto = `El corredor **${nombre}** llegó a la meta en el puesto **${data.numeroEnCarrera}** con un tiempo de **${data.tiempo}**.`;

                    const mensajeMetaDiv = document.getElementById("mensajeMeta");
                    mensajeMetaDiv.textContent = `<i class="fas fa-medal me-2"></i>${texto}`;
                    mensajeMetaDiv.classList.remove('alert-warning');
                    mensajeMetaDiv.classList.add('alert-success');
                    mensajeMetaDiv.style.display = "block";

                    
                    connection.stop();
                    console.log("Conexión SignalR detenida, el corredor ha finalizado.");
                }
            });

            // Iniciar Conexión
            connection.start()
                .then(() => {
                    console.log("Conectado a SignalR.");
                    connection.invoke("UnirseACorredorCorriendoceUnaCarreraCarrerosa", @Model.registroId)
                        .catch(err => console.error("Error al invocar UnirseACorredorCorriendoceUnaCarreraCarrerosa:", err));
                })
                .catch(err => console.error("Error al conectar a SignalR:", err));
        });
    </script>
}

<style>
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }

    .avatar-circle {
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .bg-primary {
        background: linear-gradient(135deg, var(--bs-primary) 0%, #0056b3 100%) !important;
    }

    .bg-pink {
        background: linear-gradient(135deg, #e83e8c 0%, #d91a72 100%) !important;
    }

    .bg-info {
        background: linear-gradient(135deg, #0dcaf0 0%, #0aa7c7 100%) !important;
    }

    /* Estilos para el mensaje de meta */
    .alert-warning {
        border-left: 5px solid #ffc107;
    }

    .alert-success {
        border-left: 5px solid #198754;
    }

    .fas {
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
    }

    /* Fallbacks para iconos */
    .fa-arrow-left::before {
        content: "⬅️";
    }

    .fa-route::before {
        content: "🛣️";
    }

    .fa-running::before {
        content: "🏃";
    }

    .fa-map-pin::before {
        content: "📌";
    }

    .fa-stopwatch::before {
        content: "⏱️";
    }

    .fa-medal::before {
        content: "🏅";
    }

    .fa-chart-line::before {
        content: "📈";
    }

    .fa-chart-bar::before {
        content: "📊";
    }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">